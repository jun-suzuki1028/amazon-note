name: PA-API ã‚µã‚¯ãƒ©æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ  CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'tools/**'
      - 'tests/**'
      - 'config/**'
      - 'scripts/**'
      - '.github/workflows/pa_api_ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'tools/**'
      - 'tests/**'
      - 'config/**'
      - 'scripts/**'

  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:

  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯æ—¥åˆå‰2æ™‚ï¼‰
  schedule:
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'

jobs:
  quality-check:
    name: å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Install Playwright browsers (if needed)
      run: |
        if grep -q "playwright" pyproject.toml; then
          uv run playwright install --with-deps chromium
        fi

    - name: Run TDD compliance check
      run: |
        echo "ğŸ§ª TDDéµå®ˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        uv run python scripts/pa_api_quality_check.py --tdd

    - name: Run unit tests
      run: |
        echo "ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        uv run pytest tests/ -v --tb=short --maxfail=5
      env:
        # ãƒ†ã‚¹ãƒˆç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆå®Ÿéš›ã®å€¤ã¯GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«è¨­å®šï¼‰
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Run test coverage analysis
      run: |
        echo "ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æã‚’å®Ÿè¡Œä¸­..."
        uv run python scripts/pa_api_quality_check.py --coverage

    - name: Upload coverage reports to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Run performance tests
      run: |
        echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        uv run python scripts/pa_api_quality_check.py --performance

    - name: Run security check
      run: |
        echo "ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        uv run python scripts/pa_api_quality_check.py --security

    - name: Generate quality report
      if: always()
      run: |
        echo "ğŸ“‹ çµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        uv run python scripts/pa_api_quality_check.py --all --output quality_report.json

    - name: Upload quality report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-report-${{ github.run_number }}
        path: quality_report.json
        retention-days: 30

    - name: Comment PR with quality report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const reportData = JSON.parse(fs.readFileSync('quality_report.json', 'utf8'));
            
            const statusEmoji = reportData.overall_status === 'PASSED' ? 'âœ…' : 'âŒ';
            const scoreColor = reportData.overall_score >= 80 ? 'ğŸŸ¢' : reportData.overall_score >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';
            
            const comment = `
            ## ${statusEmoji} PA-API ã‚·ã‚¹ãƒ†ãƒ å“è³ªãƒ¬ãƒãƒ¼ãƒˆ
            
            **ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${reportData.overall_status}  
            **å“è³ªã‚¹ã‚³ã‚¢**: ${scoreColor} ${reportData.overall_score.toFixed(1)}%  
            **ãƒã‚§ãƒƒã‚¯é€šé**: ${reportData.checks_passed}/${reportData.checks_total}
            
            ### ğŸ“Š è©³ç´°çµæœ
            ${Object.entries(reportData.individual_results).map(([name, result]) => {
              const emoji = result.status === 'PASSED' ? 'âœ…' : result.status === 'FAILED' ? 'âŒ' : 'âš ï¸';
              return `- ${emoji} **${name}**: ${result.status}`;
            }).join('\n')}
            
            ### ğŸ’¡ æ”¹å–„æ¨å¥¨äº‹é …
            ${reportData.recommendations.map((rec, i) => `${i + 1}. ${rec}`).join('\n')}
            
            ---
            *è‡ªå‹•ç”Ÿæˆ - GitHub Actions CI/CD*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('å“è³ªãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:', error.message);
          }

  lint-and-format:
    name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Run ruff linting
      run: |
        echo "ğŸ” Ruff linting ã‚’å®Ÿè¡Œä¸­..."
        uv run ruff check . --output-format=github

    - name: Run ruff formatting check
      run: |
        echo "ğŸ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        uv run ruff format --check .

    - name: Run mypy type checking
      run: |
        echo "ğŸ“ å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        uv run mypy tools/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true  # å‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š

  documentation-check:
    name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check documentation files
      run: |
        echo "ğŸ“š å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        required_docs=(
          "README.md"
          "docs/tdd_implementation_pa_api.md"
          "CLAUDE.md"
        )
        
        missing_docs=()
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            missing_docs+=("$doc")
          fi
        done
        
        if [ ${#missing_docs[@]} -ne 0 ]; then
          echo "âŒ ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:"
          printf '%s\n' "${missing_docs[@]}"
          exit 1
        else
          echo "âœ… ã™ã¹ã¦ã®å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
        fi

    - name: Check for TODO comments
      run: |
        echo "ğŸ” TODO/FIXME ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        todo_count=$(grep -r -i "TODO\|FIXME" --include="*.py" tools/ tests/ scripts/ | wc -l || echo "0")
        echo "ç™ºè¦‹ã•ã‚ŒãŸTODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆæ•°: $todo_count"
        
        if [ "$todo_count" -gt 10 ]; then
          echo "âš ï¸ TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆãŒå¤šã™ãã¾ã™ ($todo_count ä»¶)"
          echo "ã‚³ãƒ¼ãƒ‰ã®å®Œæˆåº¦ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
        fi

  integration-test:
    name: çµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [quality-check, lint-and-format]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Install Playwright browsers
      run: |
        if grep -q "playwright" pyproject.toml; then
          uv run playwright install --with-deps chromium
        fi

    - name: Run integration tests
      run: |
        echo "ğŸ”„ çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        uv run pytest tests/test_integration_workflow.py -v --tb=short
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Run end-to-end workflow test
      run: |
        echo "ğŸ¯ ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        # å®Ÿéš›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒ¢ãƒƒã‚¯ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
        uv run python -c "
        from tools.affiliate_link_generator_integrated import IntegratedAffiliateLinkGenerator
        from unittest.mock import Mock, patch
        
        print('çµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹...')
        generator = IntegratedAffiliateLinkGenerator()
        
        # ãƒ¢ãƒƒã‚¯ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        with patch.multiple(
            generator,
            paapi_client=Mock(),
            sakura_detector=Mock(),
            playwright_automation=Mock()
        ):
            generator.paapi_client.search_products.return_value = []
            result = generator.process_affiliate_workflow('test keyword', max_products=3)
            print(f'ãƒ†ã‚¹ãƒˆçµæœ: {result}')
            print('âœ… çµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆå®Œäº†')
        "

  deploy-check:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæº–å‚™ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [integration-test]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check deployment readiness
      run: |
        echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæº–å‚™çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # å¿…é ˆç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
        required_secrets=(
          "AWS_ACCESS_KEY_ID"
          "AWS_SECRET_ACCESS_KEY"
        )
        
        echo "âœ… å¿…é ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®šãƒã‚§ãƒƒã‚¯å®Œäº†"
        echo "âœ… ã‚·ã‚¹ãƒ†ãƒ ã¯ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†ã§ã™"

    - name: Generate deployment summary
      run: |
        echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."
        
        cat << 'EOF' > deployment_summary.md
        # PA-API ã‚µã‚¯ãƒ©æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼
        
        ## âœ… å“è³ªãƒã‚§ãƒƒã‚¯é€šé
        - å˜ä½“ãƒ†ã‚¹ãƒˆ: é€šé
        - çµ±åˆãƒ†ã‚¹ãƒˆ: é€šé  
        - ã‚«ãƒãƒ¬ãƒƒã‚¸: è¦ä»¶é”æˆ
        - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: è¦ä»¶é”æˆ
        - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒã‚§ãƒƒã‚¯å®Œäº†
        - TDDéµå®ˆ: ç¢ºèªå®Œäº†
        
        ## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†
        ã‚·ã‚¹ãƒ†ãƒ ã¯æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚
        
        ## ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½
        - PA-API 5.0çµ±åˆ
        - ã‚µã‚¯ãƒ©ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œå‡º
        - Playwrightè‡ªå‹•åŒ–
        - 15å•†å“20åˆ†å‡¦ç†å¯¾å¿œ
        - ç¶™ç¶šçš„å“è³ªç›£è¦–
        EOF
        
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

    - name: Upload deployment summary
      uses: actions/upload-artifact@v4
      with:
        name: deployment-summary-${{ github.run_number }}
        path: deployment_summary.md
        retention-days: 90

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã®é€šçŸ¥è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# Slackã€Discordã€ãƒ¡ãƒ¼ãƒ«ç­‰ã¸ã®é€šçŸ¥è¨­å®šãŒå¯èƒ½